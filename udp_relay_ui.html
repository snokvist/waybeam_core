
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>UDP Relay Manager · WebUI</title>
  <style>
    :root{
      --bg:#0f1116;--panel:#151823;--muted:#8a93a5;--text:#e8ecf1;--accent:#7bd389;--warn:#e7b75f;--err:#ff7a7a;
      --green:#13391f;--green-b:#1f6b43;--blue:#0f2a45;--blue-b:#2366a2;--yellow:#3b2e13;--yellow-b:#a68124
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{margin:0;font:15px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;padding:14px 16px;background:#0c0f17;position:sticky;top:0;z-index:2;border-bottom:1px solid #1e2231}
    h1{font-size:18px;margin:0 auto 0 0;letter-spacing:.2px}
    button,input,textarea,select{font:inherit}
    label{font-size:12px;color:var(--muted)}
    input,button{background:var(--panel);color:var(--text);border:1px solid #242b3d;border-radius:12px;padding:12px 14px;outline:0}
    button{cursor:pointer;min-height:44px;border-radius:14px}
    button.primary{background:linear-gradient(180deg,#1f6b43,#165538);border-color:#1f6b43}
    button.warn{background:#3b2e13;border-color:#5c4723;color:#ffd990}
    .pill{border-radius:999px;padding:8px 12px}
    main{max-width:1100px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:1fr;gap:14px}
    section{background:var(--panel);border:1px solid #20273a;border-radius:18px;overflow:hidden}
    section h2{margin:0;padding:10px 12px;border-bottom:1px solid #20273a;font-size:14px;color:#aab3c7;background:#121626;letter-spacing:.3px}
    .pad{padding:12px}

    .chips{display:flex;flex-wrap:wrap;gap:10px}
    .chip{border:2px dashed #2a3247;border-radius:22px;padding:10px 14px;display:flex;gap:10px;align-items:center;user-select:none;min-height:44px;min-width:120px;touch-action:none}
    .chip[draggable=true]{cursor:grab}
    .chip.selected{outline:3px solid #4ea2ff}
    .chip .tag{opacity:.7;font-size:12px}
    .chip .x{margin-left:8px;border:none;background:transparent;color:#ffb3b3;font-weight:700;cursor:pointer;padding:2px 6px;border-radius:8px;min-height:0}
    .chip .x:hover{background:#2a0f0f}.chip .x:active{transform:scale(0.96)}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .dest{min-height:100px;border:3px dashed #2b344d;border-radius:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px;transition:.15s;touch-action:none}
    .dest.drag-over{transform:scale(0.99)}
    .dest .info{display:flex;flex-direction:column;gap:4px}
    .dest .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:14px;word-break:break-all}
    .muted{color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .log{height:160px;overflow:auto;background:#0c0f17;border:1px solid #1e2231;border-radius:12px;padding:10px}
    .ok{color:var(--accent)}.warn{color:var(--warn)}.err{color:var(--err)}
    .g{background:var(--green);border-color:var(--green-b)}
    .b{background:var(--blue);border-color:var(--blue-b)}
    .y{background:var(--yellow);border-color:var(--yellow-b)}
    .dest .actions{display:flex;gap:8px}
    .members{font-size:12px;opacity:.8;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>UDP Relay Manager · WebUI</h1>
    <button class="primary pill" id="refresh">Refresh</button>
    <button class="warn pill" id="clearAll">Clear ALL</button>
  </header>

  <main>
    <section>
      <h2>Binds — drag or tap-then-tap</h2>
      <div class="pad">
        <div class="chips" id="bindChips"></div>
        <div class="muted" style="margin-top:6px">Tip: select a bind, then tap a destination/group. Or drag bind → destination/group.</div>
      </div>
    </section>

    <section>
      <h2>Destinations & Split Groups</h2>
      <div class="pad">
        <div class="muted" style="margin-bottom:8px">
          Green = Video (1→1 exclusive), Blue = Many→1 (mavlink/OSD), Yellow = Split group (1→Many).
          <br/>Groups are defined in <span class="mono">/etc/udp_relay.conf</span> as
          <span class="mono">group_yellow=&lt;name&gt;|ip:port,ip:port,...</span>
        </div>
        <h3 class="muted" style="margin:6px 0 8px">Green (1→1)</h3>
        <div id="destGridG" class="grid" style="margin-bottom:12px"></div>
        <h3 class="muted" style="margin:6px 0 8px">Blue (many→1)</h3>
        <div id="destGridB" class="grid" style="margin-bottom:12px"></div>
        <h3 class="muted" style="margin:6px 0 8px">Yellow (split groups)</h3>
        <div id="destGridY" class="grid"></div>
      </div>
    </section>

    <section>
      <h2>Live Status</h2>
      <div class="pad" id="statusBox"><div class="muted">Loading…</div></div>
    </section>

    <section>
      <h2>Log</h2>
      <div class="pad"><div id="log" class="log mono"></div></div>
    </section>
  </main>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const log = (m, c='') => {
      const el = $('#log');
      const d = document.createElement('div');
      if (c) d.className = c;
      d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
      el.prepend(d);
    };

    // --- HTTP helpers ---
    const GET = p =>
      fetch(p).then(r => { if(!r.ok) throw new Error(r.statusText); return p.includes('/status') ? r.json() : r.text(); });

    const POST_JSON = (p, obj) =>
      fetch(p, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj||{}) })
        .then(async r => { if(!r.ok) throw new Error(await r.text()); try{ return await r.json(); }catch{ return await r.text(); }});

    const action = (verb, o) => POST_JSON(`/api/v1/action/${verb}`, o||{});

    // --- State ---
    const state = {
      status:null,
      cfgText:'',
      green:[],           // ["ip:port", ...]
      blue:[],            // ["ip:port", ...]
      yellowGroups:[],    // [{name:"splitA", members:["ip:port", ...]}, ...]
      selected:null
    };

    // --- Parse config for cards (read-only) ---
    const normDest = s => {
      s = String(s||'').trim();
      const m = s.match(/^([^:\s]+):([0-9]+)$/);
      return m ? `${m[1]}:${m[2]}` : null;
    };

    function parseConfigForUI(txt){
      state.cfgText = String(txt||'').replace(/\r/g,'');
      const greens = new Set();
      const blues  = new Set();
      const groups = [];

      for(const raw of state.cfgText.split(/\n/)){
        const ln = raw.trim();
        if(!ln || ln.startsWith('#') || ln.startsWith(';')) continue;

        // dest_green=ip:port
        let m = ln.match(/^dest_green\s*=\s*(\S+)$/i);
        if(m){ const d = normDest(m[1]); if(d) greens.add(d); continue; }

        // dest_blue=ip:port
        m = ln.match(/^dest_blue\s*=\s*(\S+)$/i);
        if(m){ const d = normDest(m[1]); if(d) blues.add(d); continue; }

        // group_yellow=name|ip:port,ip:port,...
        m = ln.match(/^group_yellow\s*=\s*([^|]+)\|(.+)$/i);
        if(m){
          const name = m[1].trim();
          const members = [];
          m[2].split(',').forEach(tok => { const d = normDest(tok); if(d) members.push(d); });
          if(name && members.length) groups.push({ name, members });
          continue;
        }
      }
      state.green = [...greens];
      state.blue  = [...blues];
      state.yellowGroups = groups;
    }

    // --- Loaders ---
    async function loadStatus(){
      try{
        const s = await GET('/api/v1/status');
        state.status = s;
        renderBinds(s);
        renderStatus(s);
      }catch(e){
        $('#statusBox').innerHTML = `<span class=err>${e}</span>`;
      }
    }
    async function loadConfig(){
      try{
        const txt = await GET('/api/v1/config');
        parseConfigForUI(txt);
        renderDestCards();
      }catch(e){
        // If no config endpoint, still show empty grids politely.
        state.green = []; state.blue = []; state.yellowGroups = [];
        renderDestCards();
      }
    }

    // --- Helpers over status ---
    const relays = () => (state.status && state.status.relays) || [];
    const findRelay = p => relays().find(r => r.port === p);
    const listTokens = r => (r.dests || []).map(d => `${d.ip}:${d.port}`);

    async function removeDestFromPort(port, dest){ await action('clear_to', { port, dest }); }
    async function clearDestinationEverywhere(dest){
      for(const r of relays()){
        if(listTokens(r).includes(dest)) await removeDestFromPort(r.port, dest);
      }
    }
    async function clearAll(){
      for(const r of relays()) await action('clear', { port:r.port });
    }

    // --- Apply operations ---
    // Green = enforce exclusivity to ONE destination globally.
    async function dropGreen(srcPort, dest){
      await clearDestinationEverywhere(dest);
      await action('set', { port:srcPort, dests:[dest] });   // replace on this bind
      log(`bind ${srcPort} → ${dest} (1→1)`, 'ok');
      await loadStatus();
    }
    // Blue = many→1, append if not present.
    async function dropBlue(srcPort, dest){
      const r = findRelay(srcPort); if(!r) return;
      const tokens = new Set(listTokens(r));
      if(!tokens.has(dest)){
        await action('append', { port:srcPort, dests:[dest] });
        log(`bind ${srcPort} +→ ${dest}`, 'ok');
      } else {
        log(`already mapped: ${srcPort} has ${dest}`, 'warn');
      }
      await loadStatus();
    }
    // Yellow group = 1→Many; REPLACE bind's dests with full group members.
    async function dropYellowGroup(srcPort, group){
      if(!group || !Array.isArray(group.members) || !group.members.length) return;
      await action('set', { port:srcPort, dests: group.members });
      log(`bind ${srcPort} ⇒ [${group.name}] (${group.members.length} members)`, 'ok');
      await loadStatus();
    }

    // --- DnD/tap helpers ---
    function makeDropTarget(el, onDo){
      const allow = e => { e.preventDefault(); e.stopPropagation(); };
      el.addEventListener('dragenter', allow);
      el.addEventListener('dragover', e => { allow(e); el.classList.add('drag-over'); });
      el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
      el.addEventListener('drop', e => {
        allow(e); el.classList.remove('drag-over');
        const txt = e.dataTransfer.getData('text/plain');
        const p = parseInt(txt, 10);
        if (p) onDo(p).catch(err => log(err, 'err'));
      });
      el.addEventListener('click', () => { if (state.selected) onDo(state.selected).catch(err => log(err, 'err')); });
    }

    // --- UI renderers ---
    function makeDestCard(dest, type){
      const card = document.createElement('div');
      card.className = `dest ${type}`;
      const label = (type==='g') ? 'Video (1→1)' : 'Many→1';
      card.innerHTML =
        `<div class='info'>
           <div class='muted'>${label}</div>
           <div class='mono'>${dest}</div>
         </div>
         <div class='actions'>
           <button class='pill' data-cc='1' title="Remove this destination from all binds">Clear everywhere</button>
         </div>`;
      makeDropTarget(card,
        type==='g' ? (p)=>dropGreen(p, dest) : (p)=>dropBlue(p, dest)
      );
      card.querySelector('[data-cc]')?.addEventListener('click', async (e)=>{
        e.stopPropagation();
        await clearDestinationEverywhere(dest);
        log(`Cleared ${dest} from all binds`, 'ok');
        await loadStatus();
      });
      return card;
    }

    function makeGroupCard(group){
      const card = document.createElement('div');
      card.className = `dest y`;
      const list = group.members.join(', ');
      card.innerHTML =
        `<div class='info'>
           <div class='muted'>Split group (1→Many)</div>
           <div><strong>${group.name}</strong> <span class='muted'>· ${group.members.length} members</span></div>
           <div class='mono members'>${list}</div>
         </div>
         <div class='actions'>
           <button class='pill' data-apply='1' title="Apply group to selected bind">Apply</button>
         </div>`;
      makeDropTarget(card, (p)=>dropYellowGroup(p, group));
      card.querySelector('[data-apply]')?.addEventListener('click', async (e)=>{
        e.stopPropagation();
        if(!state.selected){ log('Select a bind first', 'warn'); return; }
        await dropYellowGroup(state.selected, group);
      });
      return card;
    }

    function renderDestCards(){
      const g = $('#destGridG'), b = $('#destGridB'), y = $('#destGridY');
      g.innerHTML = ''; b.innerHTML = ''; y.innerHTML = '';

      if(!state.green.length){
        const m=document.createElement('div'); m.className='muted'; m.textContent='No green destinations in config.'; g.appendChild(m);
      } else {
        for(const d of state.green) g.appendChild(makeDestCard(d,'g'));
      }
      if(!state.blue.length){
        const m=document.createElement('div'); m.className='muted'; m.textContent='No blue destinations in config.'; b.appendChild(m);
      } else {
        for(const d of state.blue) b.appendChild(makeDestCard(d,'b'));
      }
      if(!state.yellowGroups.length){
        const m=document.createElement('div'); m.className='muted'; m.textContent='No yellow split groups in config.'; y.appendChild(m);
      } else {
        for(const grp of state.yellowGroups) y.appendChild(makeGroupCard(grp));
      }
    }

    function renderBinds(s){
      const wrap = $('#bindChips');
      const sel = state.selected;
      wrap.innerHTML = '';
      (s.relays||[]).forEach(r => {
        const el = document.createElement('div');
        el.className = 'chip';
        el.draggable = true;
        el.dataset.port = String(r.port);
        el.innerHTML = `<strong>bind ${r.port}</strong> <span class='tag'>in:${r.pkts_in||0}</span>`;
        el.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', String(r.port));
          e.dataTransfer.effectAllowed = 'copy';
        });
        el.addEventListener('click', () => {
          if (state.selected === r.port){ state.selected = null; el.classList.remove('selected'); }
          else {
            state.selected = r.port;
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
          }
        });
        if (sel === r.port) el.classList.add('selected');
        wrap.appendChild(el);
      });
    }

    function renderStatus(s){
      const box = $('#statusBox');
      if(!s || !Array.isArray(s.relays)){ box.innerHTML = '<div class=muted>No relays</div>'; return; }
      const frag = document.createDocumentFragment();
      for(const r of s.relays){
        const outPkts = Array.isArray(r.dests) ? r.dests.reduce((a,d)=>a+(d.pkts||0),0) : 0;
        const oneToOne = (Array.isArray(r.dests) && r.dests.length===1);
        const row = document.createElement('div');
        row.className = 'dest';
        row.style.borderStyle = 'solid';
        row.innerHTML =
          `<div>
             <div><strong>bind ${r.port}</strong></div>
             <div class='muted'>
               in pkts ${r.pkts_in} · out pkts ${outPkts}${oneToOne ? ' (1→1)' : ''} · out bytes ${r.bytes_out} · errs ${r.send_errs}
             </div>
           </div>
           <div class='actions'>
             <button class='pill' data-clear='${r.port}'>Clear bind</button>
           </div>`;
        row.querySelector('[data-clear]')?.addEventListener('click', ()=>{
          action('clear',{port:r.port})
            .then(()=>{ log(`cleared ${r.port}`,'ok'); loadStatus(); })
            .catch(e=>log(e,'err'));
        });
        frag.appendChild(row);

        // Under the row, show current dest chips with remove "x"
        const destsLine = document.createElement('div');
        destsLine.className = 'chips';
        destsLine.style.marginTop = '6px';
        if(Array.isArray(r.dests) && r.dests.length){
          for(const d of r.dests){
            const token = `${d.ip}:${d.port}`;
            const c = document.createElement('div');
            c.className = 'chip';
            c.innerHTML = `<span class='tag'>→</span><strong>${token}</strong> <span class='tag'>pkts ${d.pkts}</span>`;
            const x = document.createElement('button');
            x.className = 'x';
            x.title = 'Remove this destination from this bind';
            x.textContent = '×';
            x.onclick = (e) => {
              e.stopPropagation();
              removeDestFromPort(r.port, token)
                .then(()=>{ log(`Removed ${token} from bind ${r.port}`,'ok'); loadStatus(); })
                .catch(err=>log(err,'err'));
            };
            c.appendChild(x);
            destsLine.appendChild(c);
          }
        } else {
          const m = document.createElement('div');
          m.className = 'muted';
          m.textContent = 'no destinations';
          destsLine.appendChild(m);
        }
        frag.appendChild(destsLine);
      }
      box.innerHTML = '';
      box.appendChild(frag);
    }

    // --- Controls ---
    $('#refresh').onclick = () => refreshAll();
    $('#clearAll').onclick = async () => {
      try{
        await clearAll();
        log('All mappings cleared','ok');
        await loadStatus();
      }catch(e){ log(e,'err'); }
    };

    async function refreshAll(){
      await Promise.all([loadConfig(), loadStatus()]);
    }

    // Kickoff & poll
    refreshAll();
    setInterval(()=>loadStatus().catch(()=>{}), 1500);
  })();
  </script>
</body>
</html>
